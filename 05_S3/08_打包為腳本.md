# 打包為腳本

_以上的 AWS CLI 指令可以打包為 Shell 腳本，並且將不同功能分開打包_

<br>

## 建立 Bucket 腳本

1. 新增腳本，命名為 `create_s3_bucket.sh`。

    ```bash
    touch create_s3_bucket.sh
    ```

<br>

2. 編輯腳本。

    ```bash
    #!/bin/bash

    # 設定用戶配置
    aws configure set aws_access_key_id YOUR_ACCESS_KEY_ID --profile s3user
    aws configure set aws_secret_access_key YOUR_SECRET_ACCESS_KEY --profile s3user
    aws configure set region us-east-1 --profile s3user
    aws configure set output json --profile s3user

    # 建立政策文件
    cat <<EOL > s3_policy.json
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Action": [
                    "s3:PutBucketPolicy",
                    "s3:GetBucketPolicy",
                    "s3:ListBucket",
                    "s3:PutObject",
                    "s3:GetObject",
                    "s3:DeleteObject",
                    "s3:DeletePublicAccessBlock",
                    "s3:GetPublicAccessBlock",
                    "s3:PutEncryptionConfiguration",
                    "s3:GetEncryptionConfiguration",
                    "s3:DeleteBucket"
                ],
                "Resource": [
                    "arn:aws:s3:::my-bucket-623801",
                    "arn:aws:s3:::my-bucket-623801/*"
                ]
            }
        ]
    }
    EOL

    # 建立使用者並附加政策
    aws iam create-user --user-name s3user
    aws iam create-access-key --user-name s3user
    aws iam put-user-policy --user-name s3user --policy-name S3AccessPolicy --policy-document file://s3_policy.json

    # 建立 S3 Bucket
    aws s3api create-bucket --bucket my-bucket-623801 --region us-east-1 --profile s3user

    # 建立測試文件
    echo "這是測試文件 localfile.txt" > localfile.txt

    # 上傳文件到 S3
    aws s3 cp localfile.txt s3://my-bucket-623801/localfile.txt --profile s3user
    ```

<br>

3. 授予腳本執行權限。

    ```bash
    chmod +x create_s3_bucket.sh
    ```

<br>

4. 執行建立 S3 Bucket 的腳本。

    ```bash
    ./create_s3_bucket.sh
    ```

<br>

## 刪除 S3 Bucket 和相關設置腳本

1. 新增腳本，命名為 `delete_s3_bucket.sh`。

    ```bash
    touch delete_s3_bucket.sh
    ```

<br>

2. 編輯腳本。

    ```bash
    #!/bin/bash

    # 刪除 Bucket 中的文件
    aws s3 rm s3://my-bucket-623801 --recursive --profile s3user

    # 刪除 S3 Bucket
    aws s3api delete-bucket --bucket my-bucket-623801 --region us-east-1 --profile s3user

    # 刪除使用者的政策和訪問密鑰
    aws iam list-attached-user-policies --user-name s3user --profile default --query 'AttachedPolicies[*].PolicyArn' --output text | xargs -n 1 -I {} aws iam detach-user-policy --user-name s3user --policy-arn {} --profile default
    aws iam list-user-policies --user-name s3user --profile default --query 'PolicyNames' --output text | xargs -n 1 -I {} aws iam delete-user-policy --user-name s3user --policy-name {} --profile default
    aws iam list-access-keys --user-name s3user --profile default --query 'AccessKeyMetadata[*].AccessKeyId' --output text | xargs -n 1 -I {} aws iam delete-access-key --user-name s3user --access-key-id {} --profile default
    aws iam delete-user --user-name s3user --profile default

    # 刪除本地文件
    rm s3_policy.json localfile.txt
    ```

<br>

3. 授予腳本執行權限。

    ```bash
    chmod +x delete_s3_bucket.sh
    ```

<br>

4. 執行建立 S3 Bucket 的腳本。

    ```bash
    ./delete_s3_bucket.sh
    ```

<br>

## 查詢設置腳本

1. 新增腳本，命名為 `query_s3_settings.sh`。

    ```bash
    touch query_s3_settings.sh
    ```

<br>

2. 編輯腳本。

    ```bash
    #!/bin/bash

    # 查詢指定帳號資訊
    aws iam get-user --user-name s3user --profile default

    # 查詢附加政策
    aws iam list-attached-user-policies --user-name s3user --profile default

    # 查詢內嵌政策
    aws iam list-user-policies --user-name s3user --profile default

    # 查詢訪問密鑰
    aws iam list-access-keys --user-name s3user --profile default

    # 查詢 S3 Bucket 設置
    aws s3api list-buckets --profile s3user
    aws s3 ls s3://my-bucket-623801 --profile s3user
    aws s3api get-public-access-block --bucket my-bucket-623801 --profile default
    aws s3api head-object --bucket my-bucket-623801 --key localfile.txt --profile s3user
    ```

<br>

3. 授予腳本執行權限。

    ```bash
    chmod +x query_s3_settings.sh
    ```

<br>

4. 執行建立 S3 Bucket 的腳本。

    ```bash
    ./query_s3_settings.sh
    ```

<br>

___

_END_