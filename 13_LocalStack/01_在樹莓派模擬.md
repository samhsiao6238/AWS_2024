# LocalStack

_通過 Docker 容器模擬 AWS Lambda 服務_

<br>

## LocalStack

1. LocalStack 是一個本地 AWS 雲服務模擬器，可模擬多種 AWS 服務，包括 Lambda，可在本地開發和測試 AWS 服務。

<br>

## 停用並刪除當前運作中容器

1. 列出當前運行的 Docker 容器。

    ```bash
    docker ps
    ```

2. 停用容器。

    ```bash
    docker stop <container-id>
    ```

3. 刪除容器。

    ```bash
    docker rm <container-id>
    ```

4. 列出所有容器以確認刪除。

    ```bash
    docker ps -a
    ```

<br>

## 安裝與運行 LocalStack

1. 安裝 Docker：確保已在樹莓派上安裝了 Docker。

<br>

2. 拉取 LocalStack Docker 映像。

    ```bash
    docker pull localstack/localstack
    ```

<br>

3. 運行 LocalStack。

    ```bash
    docker run -d -p 4566:4566 -p 4571:4571 localstack/localstack
    ```

4. 設置 Docker 環境變數。

    ```bash
    export DOCKER_HOST=unix:///var/run/docker.sock
    ```

5. 確保可使用 `awslocal`，需要安裝以下幾個模組；`awscli-local` 用於與本地的模擬 AWS 服務的工具 LocalStack 互動；`awscli` 是 Amazon 提供的命令行工具，用於與 AWS 服務互動；`localstack-client` 是 LocalStack 提供的 Python 客戶端庫。

    ```bash
    pip install awscli-local awscli localstack-client
    ```

<br>

## 確認 Lambda 函數和 Role 設置


1. 建立並進入專案資料夾。

    ```bash
    cd ~/Documents && mkdir exAWS && cd exAWS
    ```

2. 創建 JSON 文件 `role-policy.json`
    ```bash
    touch role-policy.json && sudo nano role-policy.json
    ```

3. 定義 Lambda 的 IAM 角色策略
    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Principal": {
            "Service": "lambda.amazonaws.com"
          },
          "Action": "sts:AssumeRole"
        }
      ]
    }
    ```

4. 創建角色
    ```bash
    awslocal iam create-role --role-name lambda-role --assume-role-policy-document file://role-policy.json
    ```

<br>

## 創建和部署 Lambda 函數

1. 在工作目錄下創建一個名為 `lambda_function.py` 的文件。

    ```bash
    touch lambda_function.py && sudo nano lambda_function.py
    ```

2. 編輯腳本內容；儲存後退出。

    ```python
    def lambda_handler(event, context):
        return {
            'statusCode': 200,
            'body': 'Hello from Lambda!'
        }
    ```

3. 壓縮 Lambda 函數代碼。

    ```bash
    zip function.zip lambda_function.py
    ```

4. 在專案資料夾內，使用 `awslocal` 命令創建和部署 Lambda 函數；結果成功建立並顯示詳細配置。

    ```bash
    awslocal lambda create-function --function-name my-function --runtime python3.10 --role arn:aws:iam::000000000000:role/lambda-role --handler lambda_function.lambda_handler --zip-file fileb://function.zip
    ```

    _成功建立後會顯示配置_

    ```bash
    FunctionName: my-function
    Runtime: python3.10
    Role: arn:aws:iam::000000000000:role/lambda-role
    Handler: lambda_function.lambda_handler
    State: Pending - 函數正在創建中
    CodeSize: 284 bytes
    Timeout: 3 seconds
    MemorySize: 128 MB
    ```

5. 使用 `awslocal` 來測試 Lambda 函數，調用（invoke）在 LocalStack 中創建的 Lambda 函數 my-function，並將其執行結果寫入 output.txt 文件。

    ```bash
    awslocal lambda invoke --function-name my-function output.txt
    ```

6. 出現錯誤訊息表示 Lambda 函數處於 Failed 狀態，這表示在創建或更新函數時發生了某些問題，導致函數無法正確執行；特別注意，錯誤發生時，不會建立 `output.txt` 文件。

    ![](images/img_01.png)

7. 顯示 output.txt 文件的內容，從而查看 Lambda 函數的執行結果。

    ```bash
    cat output.txt
    ```

<br>

## 錯誤排除

1. 檢查 Lambda 函數的詳細狀態和錯誤原因。

## 各種檢查

1. 檢查 Docker 是否正在運行。

    ```bash
    docker ps
    ```

2. 檢查 Lambda 函數狀態。

    ```bash
    awslocal lambda get-function --function-name my-function
    ```

3. 檢查 LocalStack 容器的日誌，以確保沒有其他錯誤。

    ```bash
    docker logs <localstack-container-id>
    # 例如
    docker logs 0de469e86f8c
    ```

<br>

## 錯誤排除

1. 檢查 Lambda 函數列表，確認是否確實存在名為 my-function 的 Lambda 函數
    ```bash
    awslocal lambda list-functions
    ```

2. 函數已經存在，刪除已經存在的 Lambda 函數
    ```bash
    awslocal lambda delete-function --function-name my-function
    ```

<br>

## AWS SAM CLI

1. AWS Serverless Application Model (SAM) CLI 是一個開源框架，允許開發人員在本地開發、測試和部署無伺服器應用程式

<br>

## 安裝與運行 AWS SAM CLI

1. 安裝 Docker：確保已在樹莓派上安裝了 Docker

<br>

2. 安裝 SAM CLI：參考官方文件在樹莓派上安裝 AWS SAM CLI

<br>

3. 初始化 SAM 專案
    ```bash
    sam init
    ```

4. 運行本地 Lambda：在初始化的專案目錄中運行以下命令以本地測試 Lambda 函數
    ```bash
    sam local invoke
    ```

<br>

---

_END_