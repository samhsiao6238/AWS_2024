# 重建 AWS 系統

_在 AWS 中並沒有提供快速重建整個帳號的機制，重置帳號需要手動執行_

<br>

## 手動清理步驟

1. 刪除所有 EC2 實例。

    ```bash
    aws ec2 describe-instances --query "Reservations[].Instances[].InstanceId" --output text | xargs -n 1 aws ec2 terminate-instances --instance-ids
    ```

<br>

2. 刪除所有 S3 Bucket。

    ```bash
    aws s3 ls | awk '{print $3}' | xargs -I {} aws s3 rb s3://{} --force
    ```

<br>

3. 刪除所有 IAM 角色。

    ```bash
    aws iam list-roles --query "Roles[].RoleName" --output text | xargs -n 1 aws iam delete-role --role-name
    ```

<br>

4. 刪除所有 IAM 政策。

    ```bash
    aws iam list-policies --scope Local --query "Policies[].Arn" --output text | xargs -n 1 aws iam delete-policy --policy-arn
    ```

<br>

5. 政策刪除所有 RDS 實例政策：

    ```bash
    aws rds describe-db-instances --query "DBInstances[].DBInstanceIdentifier" --output text | xargs -n 1 aws rds delete-db-instance --db-instance-identifier --skip-final-snapshot
    ```

<br>

6. 刪除 VPC 中的資源如子網、網關等，然後刪除 VPC。

    ```bash
    aws ec2 describe-vpcs --query "Vpcs[].VpcId" --output text | xargs -n 1 aws ec2 delete-vpc --vpc-id
    ```

<br>

7. 如果有大量的資源，可以使用 CloudFormation 模板來描述基礎設施，然後刪除所有堆疊（Stacks）。

    ```bash
    aws cloudformation list-stacks --query "StackSummaries[?StackStatus=='CREATE_COMPLETE'].StackName" --output text | xargs -n 1 aws cloudformation delete-stack --stack-name
    ```

## 使用腳本自動化清理
您可以撰寫 Python 或其他腳本語言的腳本，使用 AWS SDK 來自動化上述過程。例如，使用 Boto3（Python 的 AWS SDK）來刪除所有資源。

#### 示例 Python 腳本
```python
import boto3

def delete_all_resources():
    ec2 = boto3.client('ec2')
    s3 = boto3.client('s3')
    iam = boto3.client('iam')
    rds = boto3.client('rds')
    cloudformation = boto3.client('cloudformation')

    # EC2 instances
    instances = ec2.describe_instances()['Reservations']
    for reservation in instances:
        for instance in reservation['Instances']:
            ec2.terminate_instances(InstanceIds=[instance['InstanceId']])

    # S3 buckets
    buckets = s3.list_buckets()['Buckets']
    for bucket in buckets:
        s3.delete_bucket(Bucket=bucket['Name'])

    # IAM roles
    roles = iam.list_roles()['Roles']
    for role in roles:
        iam.delete_role(RoleName=role['RoleName'])

    # IAM policies
    policies = iam.list_policies(Scope='Local')['Policies']
    for policy in policies:
        iam.delete_policy(PolicyArn=policy['Arn'])

    # RDS instances
    dbs = rds.describe_db_instances()['DBInstances']
    for db in dbs:
        rds.delete_db_instance(DBInstanceIdentifier=db['DBInstanceIdentifier'], SkipFinalSnapshot=True)

    # CloudFormation stacks
    stacks = cloudformation.list_stacks()['StackSummaries']
    for stack in stacks:
        if stack['StackStatus'] == 'CREATE_COMPLETE':
            cloudformation.delete_stack(StackName=stack['StackName'])

if __name__ == "__main__":
    delete_all_resources()
```

### 注意事項
- 政策不可逆操作政策：上述操作將永久刪除資源，無法恢復，請務必謹慎操作。
- 政策使用者帳號和根帳號政策：AWS 目前不支持自動刪除用戶帳號和根帳號，這需要手動管理。
- 政策權限問題政策：確保運行這些操作的帳號擁有足夠的權限來刪除所有資源。

這些步驟可以幫助您有效地清理並重建 AWS 帳號中的所有資源。若有更複雜的需求，可以考慮使用更高級的自動化工具，例如 Terraform 或 Ansible 來管理您的基礎設施。
