# Cloud 9

_老師使用 `90628` 的 Learner Lab_

<br>

## 步驟

1. Create Environment。

2. 選擇 SSH。

3. VPC 可不用設定。

## 說明

1. 設定完成時只有一個與環境 `test1128` 同名的 EC2，前綴是 `aws-cloud9`，尾綴是 `a8a5d4ad0c284596b1e986ae82e09b39`。

![](images/img_01.png)

2. 查詢有哪些 EC2，並僅顯示 ID 及 名稱。

```bash
aws ec2 describe-instances --query "Reservations[*].Instances[*].[InstanceId, Tags[?Key=='Name'].Value | [0]]" --output text
```

![](images/img_02.png)

## 指令

_以下使用 AWS CLI 建立、停止和終止 EC2_

1. 建立 EC2 實例，其中 `image-id` 為 AMI ID

```bash
aws ec2 run-instances \
    --image-id ami-xxxxxx
    --count 1 \
    --instance-type t2.micro
    --key-name MyKeyPair
    --security-group-ids
    --subnet-id subnet-xxxxxx
    --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=MyInstance}]'
```

2. 停止 EC2 實例

```bash
aws ec2 stop-instances \
    --instance-ids i-xxxxxx
```

3. 終止 EC2 實例

```bash
aws ec2 terminate-instances \
    --instance-ids i-xxxxxx
```

## 補充

1. 可透過以下指令查詢可用的 AMI

    ```bash
    aws ec2 describe-images --owners amazon
    ```

2. 篩選最新的 Amazon Linux AMI。

```bash
LATEST_AMI_ID=$(aws ec2 describe-images \
    --owners amazon \
    --filters "Name=name,Values=amzn2-ami-kernel-*-hvm-*-x86_64-gp2" \
              "Name=state,Values=available" \
    --query "Images | sort_by(@, &CreationDate)[-1].ImageId" \
    --output text)
```

3. 輸出查看。 

```bash
echo $LATEST_AMI_ID
```

4. 可透過以下指令查詢所有正在運行的實例

    ```bash
    aws ec2 describe-instances --query 'Reservations[*].Instances[*].InstanceId'
    ```


5. 查詢 `security-group-ids` 並選擇第一個

```bash
SECURITY_GROUP_ID=$(aws ec2 describe-security-groups \
    --query "SecurityGroups[0].GroupId" \
    --output text)

echo "Selected Security Group ID: $SECURITY_GROUP_ID"
```

2. 查詢 `subnet-ids` 並選擇前兩個

```bash
SUBNET_IDS=$(aws ec2 describe-subnets \
    --query "Subnets[0:2].SubnetId" \
    --output text)

SUBNET_ID_1=$(echo $SUBNET_IDS | awk '{print $1}')
SUBNET_ID_2=$(echo $SUBNET_IDS | awk '{print $2}')

echo "Selected Subnet ID 1: $SUBNET_ID_1"
echo "Selected Subnet ID 2: $SUBNET_ID_2" \

```

3. 創建新的 Key Pair。 

```bash
aws ec2 create-key-pair \
    --key-name MyKeyPair \
    --query "KeyMaterial" \
    --output text > MyKeyPair.pem
```

4. 使用上述變數建立 EC2，選用其中的第一個子網

```bash
aws ec2 run-instances \
    --image-id $LATEST_AMI_ID \
    --count 1 \
    --instance-type t2.micro \
    --key-name MyKeyPair \
    --security-group-ids $SECURITY_GROUP_ID \
    --subnet-id $SUBNET_ID_1 \
    --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=MyInstance}]'

echo "EC2 instance created with the following parameters:"
echo "AMI ID: $LATEST_AMI_ID"
echo "Security Group ID: $SECURITY_GROUP_ID"
echo "Subnet ID: $SUBNET_ID_1" \

```


