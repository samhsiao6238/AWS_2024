# 修改主腳本

## 步驟說明

1. 延續 `04_本地 Linebot` 的腳本如下。

```python
# 與原本腳本一致
```

2. 建立 `Flask` 之後，添加 `DynamoDB 資源`。

```python
# 初始化 Flask 應用
application = Flask(__name__)

configuration = Configuration(access_token=CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(CHANNEL_SECRET)

'''以下是添加的內容'''
# 初始化 DynamoDB 資源
dynamodb = boto3.resource(
    'dynamodb', region_name='us-east-1'
)
table_name = "LinebotMessages"
table = dynamodb.Table(table_name)


# 自訂函數儲存對話
def save_message_to_dynamodb(user_id, message):
    try:
        table.put_item(
            Item={
                'UserId': user_id,
                'Timestamp': datetime.utcnow().isoformat(),
                'Message': message,
            }
        )
        print(f
        "訊息已保存到 DynamoDB：{user_id}, {message}")
    except Exception as e:
        print(
            f"保存到 DynamoDB 時發生錯誤：{e}"
        )
```

3. 修改 `handle_message()` 函數；可直接覆蓋原本的內容。

```python
@handler.add(MessageEvent, message=TextMessageContent)
def handle_message(event):
    application.logger.info(f"Received Event：{event}")
    # 取得使用者 ID
    user_id = event.source.user_id
    # 取得使用者訊息
    user_message = event.message.text

    # 保存訊息到 DynamoDB
    save_message_to_dynamodb(user_id, user_message)

    with ApiClient(configuration) as api_client:
        messaging_api = MessagingApi(api_client)
        reply_token = event.reply_token
        response_message = TextMessage(
            text=f"你說了：{user_message}"
        )
        messaging_api.reply_message_with_http_info(
            ReplyMessageRequest(
                reply_token=reply_token,
                messages=[response_message],
            )
        )
```

4. 修改 `requirements.txt`，添加 `boto3`。

```json
Flask==2.3.2
gunicorn==20.1.0
line-bot-sdk==3.14.2
boto3==1.28.52
```