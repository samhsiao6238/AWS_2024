# 流水筆記


## 建立 S3 Bucket

_以下使用標準視窗建立 Bucket 實例_

<br>

1. 進入 S3 的 Bucket，點擊 `Create bucket` 建立 Bucket。

![](images/img_04.png)

2. 命名如 `bucket102501`

3. 選擇 `ACLs enabled`

4. `Block Public Access settings` 預設是全部勾選的，也就是啟動了封鎖；特別注意，這時的勾選狀態顯示如下，之後會再來來觀察。

![](images/img_01.png)

5. 手動將勾選取消，也就是不進行封鎖，所以在下方要點擊 `I acknowledge ...` 表示知悉風險。

![](images/img_05.png)

6. 其他設定不變，點擊 `Create bucket` 完成建立 bucket。

![](images/img_06.png)

## 準備工作

_AWS CLI_

1. 開啟之前的操作文本，在 `第二部分` 加入兩個變數 `Bucket_name`、`My_region`，其中  `Bucket_name` 填入 `mybuctket1025`，`My_region` 使用預設的 `us-east-1`。

```bash
# 第一部分：複製 AWS CLI 貼上，格式不重要，稍後會直接覆蓋
[default]
aws_access_key_id=
aws_secret_access_key=
aws_session_token=

# 第二部分：在操作步驟中逐一複製
Instance_ID=
Public_IPv4_address=
Security_groups=
Username=Administrator
Password=''
Shared_Name_of_Drive_C=C_Drive
# 加入
Bucket_name=
My_region=us-east-1

# 第三部分：建立環境變數
export AWS_ACCESS_KEY_ID=$aws_access_key_id
export AWS_SECRET_ACCESS_KEY=$aws_secret_access_key
export AWS_SESSION_TOKEN=$aws_session_token
```

2. 建立環境變數，假如其他部分已經設定過，可複製添加的兩行到終端機中建立，這裡假設名稱就是 `bucket102502`；假如初次建立，可省略 `EC2` 實例的部分；特別說明，這裡使用的名稱 `bucket102502` 是為了區別  `bucket102501`，以利後續的步驟比較。

```bash
Bucket_name=bucket102503
My_region=us-east-1
```

3. 完成準備工作後，務必先檢查當前登入資訊。

```bash
aws sts get-caller-identity
```

4. 確認為自己 Learner Lab 的 ID。

![](images/img_08.png)

## 使用 AWS CLI 建立 Bucket 

1. 建立新的 Bucket，完成後會傳回新的 Bucket 的名稱。

```bash
aws s3api create-bucket --bucket $Bucket_name --region $My_region
```

![](images/img_07.png)

2. 取消 S3 Bucket 的公共存取限制，也就是取消勾選預設的封鎖設定；注意，這個指令並無回傳值。

```bash
aws s3api put-public-access-block --bucket $Bucket_name --public-access-block-configuration BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false
```

3. 進入主控台查看，這時候的狀態是 `off`，也就是並未進行封鎖。

![](images/img_02.png)

4. 允許所有人訪問該 Bucket 中的所有對象；特別注意，這樣設定後，所有上傳的文件都是公開的。

```bash
policy=$(cat << EOF
{
    "Version": "2012-10-17",
    "Statement": [
        {
        "Effect": "Allow",
        "Principal": "*",
        "Action": "s3:GetObject",
        "Resource": "arn:aws:s3:::$Bucket_name/*"
        }
    ]
}
EOF
)

echo "$policy" | envsubst | aws s3api put-bucket-policy --bucket $Bucket_name --policy file://<(echo "$policy" | envsubst)
```

5. 查看下方 `Bucket policy` 區塊，確定順利寫入了 Policy。

![](images/img_03.png)

6. 查詢當前 Buckets。

```bash
aws s3api list-buckets --query "Buckets[].Name"
```

![](images/img_09.png)

7. 查詢指定 Bucket 資訊，這裡查詢新建立的 `bucket102503`。

```bash
aws s3api get-bucket-acl --bucket $Bucket_name
```

![](images/img_10.png)

8. 特別說明，當查詢 Bucket 的區域時，如果 Bucket 是在 `us-east-1` 中建立的，當查詢它的地理位置時，返回值會是 `null`，這並不是錯誤，而是表示 Bucket 位於 `N. Virginia`。

```bash
aws s3api get-bucket-location --bucket $Bucket_name
```

9. 查詢 Bucket 的公共訪問設定。

```bash
aws s3api get-public-access-block --bucket $Bucket_name
```

![](images/img_11.png)

10. 查詢 Bucket 的政策。

```bash
aws s3api get-bucket-policy --bucket $Bucket_name
```

11. 列出特定 Bucket 內的物件。

```bash
aws s3 ls s3://$Bucket_name --recursive
```

## 上傳文件

_當前路徑中準備一張圖片 `monkey.jpeg`_

![](images/monkey.jpeg)

1. 將圖片名稱設定為環境參數。

```bask
Image_path=monkey.jpeg
```

2. 上傳圖片到 S3 Bucket。

```bash
aws s3 cp $Image_path s3://$Bucket_name/
```

3. 可在主控台中觀察，確實添加了一張圖片。

![](images/img_12.png)

4. 獲取該物件的詳細資訊。

```bash
aws s3api head-object --bucket $Bucket_name --key $Image_path
```

![](images/img_13.png)

4. 禁用 Block Public ACL 設置。

```bash
aws s3api put-public-access-block --bucket $Bucket_name --public-access-block-configuration BlockPublicAcls=false
```

5. 更新 Bucket Policy

```bash
aws s3api put-bucket-policy --bucket $Bucket_name --policy '{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::'$Bucket_name'/*"
    }
  ]
}'
```

6. 檢查 Policy

```bash
aws s3api get-bucket-policy --bucket $Bucket_name
```

7. 訪問物件

```bash
open -a "Google Chrome" https://$Bucket_name.s3.amazonaws.com/monkey.jpeg
```

