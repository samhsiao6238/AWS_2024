# 實作多語言解決方案

_官方範例說明，這個 Lab 將使用三種不同的 AWS 服務，分別處理 `音檔轉文本`、`文本轉音檔` 以及 `不同語言間的翻譯`。_

<br>

## 範例與使用的服務簡介

1. Amazon Transcribe example，語音轉文本服務；上傳音訊文件至 S3，啟動 Transcribe 轉錄作業，也就是將音檔轉換為文本；運作時需指定音訊格式和語言等參數，轉錄結果可儲存在 S3 中，或在 Transcribe 控制台中檢視並下載 JSON 格式的轉錄文本。

<br>

2. Amazon Translate example，自動翻譯服務；上傳待翻譯的文本文件至 S3，啟動 Translate 翻譯作業，指定 `來源語言` 和 `目標語言`，可以是一對多的翻譯，翻譯結果文件儲存在指定的 S3 路徑中，供進一步使用或下載。

<br>

3. Amazon Polly example，文本轉語音服務；上傳要轉換的文本至 S3，也可直接傳遞文本，然後啟動 Polly 語音合成作業，指定語音引擎、音訊格式和語音 ID，語音合成結果儲存在 S3 中，通常為 MP3 格式的音頻文件，可進行下載或直接播放。

<br>

## 建立本地授權

_使用 Lab 提供的 STS 服務，Security Token Service；因為要在本地運行專案，所以要建立本地運行環境，假如在 Sagemaker 中運行，可以省略本地授權的部分。_

<br>

1. 建立任意的專案資料夾並進入，在其中新增三個文檔；接著啟動 VSCode。

    ```bash
    cd ~/Desktop && mkdir _test_ && cd _test_
    touch .env .gitignore test.ipynb
    code .
    ```

<br>

2. 在 `.gitignore` 中貼上以下內容。

    ```bash
    .env
    ```

<br>

3. 在 `.env` 文件中貼上 Lab 主控台所取得的 `aws_access_key_id`、`aws_secret_access_key`、`aws_session_token`。

    ![](images/img_15.png)

<br>

4. 接著在 `.env` 文件中貼上以下語句，這樣便可將取得的憑證導入，並添加設置 Region。

    ```json
    AWS_ACCESS_KEY_ID=${aws_access_key_id}
    AWS_SECRET_ACCESS_KEY=${aws_secret_access_key}
    AWS_SESSION_TOKEN=${aws_session_token}
    AWS_DEFAULT_REGION=us-east-1
    ```

<br>

5. 在 `test.ipynb` 中貼上並運行以下代碼，這會透過取得 Account ID 驗證 AWS 本機設置正確完成。

    ```python
    import boto3
    
    # 載入 .env 檔案中的環境變數
    from dotenv import load_dotenv
    import os
    load_dotenv()

    # 建立 STS 客戶端
    sts_client = boto3.client("sts")

    # 呼叫 get_caller_identity 以取得當前 AWS 帳號資訊
    response = sts_client.get_caller_identity()
    account_id = response["Account"]

    print(f"AWS Account ID: {account_id}")
    ```

    _輸出結果為_

    ![](images/img_01.png)

<br>

6. 開啟主控台進行比對，確認與 Lab 當前的 Account ID 相同，以上完成驗證。

    ![](images/img_14.png)

<br>

## 取得資源資訊

_為了提升腳本自動化運行的能力，修正原本官方腳本中硬編碼，以下將自動取回資源名稱並進行篩選，然後自動帶入後續步驟中_

<br>

1. 透過代碼自動取得 Lab 所指派的所有 `Role name` 和 `ARN（資源名稱）`，並根據名稱篩選範例所需的角色；特別說明，這裡的篩選條件是依據 Lab 角色使用的命名規則推論而來，並非統一性的規範。

    ```python
    # 建立 IAM 客戶端
    iam_client = boto3.client("iam")

    # 取得所有角色
    def list_roles():
        try:
            # 透過客戶端取得所有角色
            response = iam_client.list_roles()

            # 儲存所有角色的名稱和 ARN
            roles = {role["RoleName"]: role["Arn"] for role in response["Roles"]}
            return roles
        except Exception as e:
            print(f"無法取得角色列表。錯誤訊息：{e}")
            return None


    # 自訂義篩選角色的函數，函數需傳入關鍵字進行篩選
    def get_role_arn(role_keyword):
        try:
            # 呼叫 list_roles 方法以取得所有角色
            response = iam_client.list_roles()
            # 遍歷所有角色以篩選出包含指定關鍵字的角色 ARN
            for role in response["Roles"]:
                if role_keyword in role["RoleName"]:
                    return role["Arn"]
            print(f"無法找到包含關鍵字 '{role_keyword}' 的角色。")
            return None
        except Exception as e:
            print(f"無法取得角色列表。錯誤訊息：{e}")
            return None


    # 定義要搜尋的角色關鍵字
    database_role_keyword = "ComprehendDataAccessRole"
    translate_role_keyword = "TranslateDemoRole"

    # 取得包含 'ComprehendDataAccessRole' 的角色 ARN
    database_access_role_arn = get_role_arn(
        database_role_keyword
    )
    # 取得包含 'TranslateDemoRole' 的角色 ARN
    translate_access_role_arn = get_role_arn(
        translate_role_keyword
    )

    # 輸出查看
    print(
        f"Database Access Role ARN：【{database_access_role_arn}】"
    )
    print(
        f"Translate Access Role ARN：【{translate_access_role_arn}】"
    )
    ```

    ![](images/img_02.png)

<br>

2. 篩選出名稱中包含 `labbucket` 的 Bucket，後續代碼將使用這個 Bucket 作為存放資料對象。

    ```python
    # 建立 S3 客戶端
    s3_client = boto3.client("s3")

    # 列出 Buckets
    def list_buckets():
        try:
            # 呼叫 list_buckets 方法以取得所有 bucket
            response = s3_client.list_buckets()

            # 從回應中提取每個 bucket 名稱並篩選包含 'labbucket' 的
            bucket_names = [
                bucket["Name"]
                for bucket in response["Buckets"]
                if "labbucket" in bucket["Name"]
            ]
            return bucket_names
        except Exception as e:
            print(f"無法取得 bucket 列表。錯誤訊息：{e}")
            return None


    # 取得篩選後的 bucket 名稱
    bucket_names = list_buckets()

    # 顯示取得的 bucket 名稱
    if bucket_names:
        print("包含 'labbucket' 的 Bucket 名稱列表：")
        for name in bucket_names:
            print(name)
    else:
        print("沒有找到包含 'labbucket' 的 Bucket。")
    ```

    ![](images/img_03.png)

<br>

3. 調用以上步驟建立的函數，進一步建立篩選資源的函數 `list_buckets_with_keyword`。

    ```python
    # 生成全域唯一識別碼
    import uuid

    # 處理 JSON 格式的數據
    import json

    # 從 time 模組匯入 sleep 函數，用於讓程式暫停指定的秒數
    from time import sleep

    # 自訂義篩選 Bucket 的函數，需傳入關鍵字進行篩選
    def list_buckets_with_keyword(keyword):
        try:
            # 調用 list_buckets 取得所有 bucket
            response = s3_client.list_buckets()
            bucket_names = [
                # 篩選包含特定關鍵字的名稱
                # 特別注意這是 inline 的表達式，斷行不要縮排
                bucket["Name"]
                for bucket in response["Buckets"]
                if keyword in bucket["Name"]
            ]
            if bucket_names:
                # 假設只取第一個符合條件的 bucket 名稱
                return bucket_names[0]
            else:
                print(f"沒有找到包含 '{keyword}' 的 bucket。")
                return None
        except Exception as e:
            print(f"無法取得 bucket 列表。錯誤訊息：{e}")
            return None


    # 取得包含 'labbucket' 的 S3 bucket 名稱
    bucket = list_buckets_with_keyword("labbucket")

    # 輸出以上步驟取得的 ARN
    print(f"S3 Bucket 名稱：【{bucket}】")
    ```

    ![](images/img_13.png)

<br>

## Amazon Transcribe example

_完成準備工作後開始官方範例，第一步：透過 SDK 使用服務 `Amazon Transcribe` 將音訊檔案轉換為文字_

<br>

1. 檢查 Bucket 是否存在，以及當前帳號是否具備訪問的權限；透過 S3 客戶端對指定的 Bucket 執行 `head_bucket` 請求，以確認該 Bucket 是否存在並且有權限訪問，`head_bucket` 方法會向指定的 Bucket 發送一個 `HEAD` 請求，檢查 Bucket 的存在性與訪問權限，但不會下載或顯示任何 Bucket 中的物件內容。

    ```python
    try:
        # 建立該 Bucket 的客戶端
        s3_client.head_bucket(Bucket=bucket)
        # 成功的話就會輸出這個訊息
        print("Bucket exists and is accessible.")
    except Exception as e:
        print(f"Error accessing bucket: {e}")
    ```

    ![](images/img_05.png)

<br>

2. 使用前面步驟取得的 Bucket 名稱，組建範例文件 `test.wav` 所在的路徑，該文件是一個音頻檔案，內容是 `Test、Hello、Hello、Hello。This is a test、Test、Test、Test。`

    ```python
    media_input_uri = f"s3://{bucket}/lab71/transcribe-sample/test.wav"
    print(media_input_uri)
    ```

    _輸出 `s3://` 開頭的 URL_

    ![](images/img_29.png)

<br>

3. 可以在 S3 主控台中點擊文件進入查看詳細內容。

    ![](images/img_16.png)

<br>

4. 右下角會顯示該文件的 Object URL，但這是以 `https://` 協定表示；因為 `s3://` 前綴的 URI 是 AWS 內部的對象路徑標識，用於在 SDK 中直接訪問 S3 對象，也就是程式碼中對 S3 對象進行操作時使用，與物件的公共 IP 不同。

    ![](images/img_30.png)

<br>

## 使用 `start_transcription_job`

_啟動新的轉錄作業，將指定的音訊文件傳送至 Amazon Transcribe 進行轉錄_

<br>

1. 使用前一個步驟生成的路徑 `media_input_uri`，也就是以 `test.wav` 檔案，並用來作為輸入；特別說明，這裡使用的是 `uuid1()` 來生成唯一識別碼，這基於當前的時間戳和主機的 MAC 地址來生成，另外還有 `uuid3()` 基於命名空間和名稱生成、`uuid4()` 是基於隨機數生成、`uuid5()` 使用 `SHA-1 哈希算法` 來生成 `UUID`。

    ```python
    # 建立 AWS Transcribe 的客戶端
    transcribe_client = boto3.client("transcribe")

    # 生成 UUID 作為此轉錄作業的名稱
    job_uuid = uuid.uuid1()
    # 組合轉錄作業名稱
    transcribe_job_name = f"transcribe-job-{job_uuid}"
    # 自訂義轉錄輸出的檔案名稱
    transcribe_output_filename = "transcribe_output.txt"

    # 啟動轉錄作業
    response = transcribe_client.start_transcription_job(
        # 轉錄作業的名稱
        TranscriptionJobName=transcribe_job_name,
        # 轉錄的媒體檔案 URI
        Media={"MediaFileUri": media_input_uri},
        MediaFormat="wav",
        # 音訊中的語言代碼
        LanguageCode="en-US",
        # 轉錄結果的輸出 S3 bucket
        OutputBucketName=bucket,
        # 輸出結果檔案的名稱
        OutputKey=transcribe_output_filename,
    )
    # 輸出查看
    print(response)
    ```

<br>

2. 可查看這個 `response` 的內容，其中 `TranscriptionJobStatus` 在進行中會顯示 `IN_PROGRESS`，完成時會顯示 `COMPLETED` 或 `FAILED`。

    ![](images/img_17.png)

<br>

3. 檢查回傳值中 `transcription job` 的狀態，直到顯示 `COMPLETED` 或 `FAILED` 為止。

    ```python
    job = None
    while True:
        # 指定轉錄工作狀態，並將結果存放在變數 job 中
        # transcribe_job_name 是轉錄工作的名稱。
        job = transcribe_client.get_transcription_job(
            TranscriptionJobName=transcribe_job_name
        )

        # 檢查轉錄工作狀態
        if job["TranscriptionJob"]["TranscriptionJobStatus"] in ["COMPLETED", "FAILED"]:
            # 如果符合條件，則跳出循環
            break
        print(".", end="")
        sleep(20)

    print(job["TranscriptionJob"]["TranscriptionJobStatus"])
    ```

    ![](images/img_06.png)

<br>

## 使用 `get_transcription_job` 進行查詢

_用於檢查轉錄作業的狀態和取得結果，當轉錄作業啟動之後，可使用 `get_transcription_job` 定期查詢作業狀態，分別是進行中 `IN_PROGRESS`、完成 `COMPLETED`、失敗 `FAILED`。_

<br>

1. 查看回傳值 `job` 的完整內容。

    ```python
    job
    ```

    ![](images/img_18.png)

<br>

2. 透過鍵 `TranscriptionJob`、`Transcript`、`TranscriptFileUri` 可取得輸出的路徑。

    ```python
    transcription_file = job["TranscriptionJob"]["Transcript"]["TranscriptFileUri"]
    print(transcription_file)
    ```

    ![](images/img_07.png)

<br>

## 下載文件

1. 從 S3 下載音頻轉錄為文本的文件 `transcribe_output.txt`；運行後無回傳值，但會看到本地多了一個文件。

    ```python
    with open(transcribe_output_filename, "wb") as f:
        s3_client.download_fileobj(
            bucket,
            transcribe_output_filename,
            f
        )
    ```

<br>

2. 開啟檔案並將內容讀入 JSON 中。

    ```python
    with open(transcribe_output_filename) as f:
        data = json.load(f)
    ```

<br>

3. 可對 JSON 文件進行查看，其中包含音頻轉錄的文字。

    ```python
    print(data)
    ```

    ![](images/img_08.png)

<br>

4. 從 JSON 中確認資料所在節點，並透過鍵名來取得實際轉錄的文本內容；至此取得語音轉文字的最終結果。

    ```python
    data["results"]["transcripts"][0]["transcript"]
    ```

    ![](images/img_09.png)

<br>

5. 完成後可前往 `Amazon Transcribe` 控制台查看轉錄內容。

    ![](images/img_31.png)

<br>

6. 點擊進入查看詳細資料，此時的文本與原始音頻相同是英文的。

    ![](images/img_04.png)

<br>

## Amazon Translate example

_第二部分是進行翻譯，使用 `Amazon Translate` 服務將文字檔案從英文轉換為西班牙文；這部分相當耗時，約需要 `15` 分鐘。_

<br>

1. 首先，翻譯作業需要指定來源與輸出的位置，該服務可將來源文本翻譯成多種目標語言；以下範例翻譯為 `西班牙語`，其語言代碼為 `es`；實測在本機約需耗時 `15` 分鐘

    ```python
    # 建立 AWS Translate 的客戶端，用於呼叫 AWS Translate 服務
    translate_client = boto3.client(service_name="translate")

    # 定義輸入數據的 S3 路徑
    input_data = f"s3://{bucket}/lab71/translate-sample"

    # 定義轉譯後輸出結果的 S3 路徑
    output_data = f"s3://{bucket}"

    # 生成一個 UUID，作為此次翻譯作業的唯一識別碼
    job_uuid = uuid.uuid1()

    # 將 UUID 加入到 "translate-job-" 的前綴中
    translate_job_name = f"translate-job-{job_uuid}"

    # 啟動文本翻譯作業
    translate_job_submission = translate_client.start_text_translation_job(
        # 設定翻譯作業的名稱
        JobName=translate_job_name,
        # 配置輸入數據的參數，包含 S3 路徑和數據類型
        InputDataConfig={"S3Uri": input_data, "ContentType": "text/plain"},
        # 配置輸出數據的參數，指定輸出結果的 S3 路徑
        OutputDataConfig={"S3Uri": output_data},
        # 設定存取 AWS Translate 服務所需的 IAM 角色 ARN，以授權訪問 S3 資源
        DataAccessRoleArn=translate_access_role_arn,
        # 指定源語言的語言代碼，這裡為英文（en）
        SourceLanguageCode="en",
        # 指定目標語言的語言代碼，這裡為西班牙語（es）
        TargetLanguageCodes=["es"],
    )

    # 從作業提交的回應中提取 Job ID
    # 將 ID 儲存到 translate_job_id 變數中
    translate_job_id = translate_job_submission["JobId"]

    # 使用 ID 來取得狀態，等待作業完成
    while True:
        translate_job = translate_client.describe_text_translation_job(
            JobId=translate_job_id
        )
        if translate_job["TextTranslationJobProperties"]["JobStatus"] in [
            "COMPLETED",
            "FAILED",
        ]:
            break
        sleep(20)
        print(".", end="")

    print(translate_job["TextTranslationJobProperties"]["JobStatus"])
    ```

    ![](images/img_10.png)

<br>

2. 這個過程很久，同樣可以進入 `Amazon Translate` 主控台查看，當程序還在運行時，會顯示 `In peogress`。

    ![](images/img_19.png)

<br>

3. 完成時會顯示 `Completed`，點擊可查看細節，此一任務的來源是英文，而目標是西班牙文。

    ![](images/img_20.png)

<br>

4. 輸出資料夾的格式是根據帳號和作業 ID 建立的，使用此資訊建立一條路徑。

    ```python
    # 獲取當前 AWS 帳戶的 ID
    account_id = boto3.client("sts").get_caller_identity().get("Account")

    # 定義翻譯輸出結果的 S3 路徑
    # 使用帳戶 ID、固定的 "TranslateText" 標識、翻譯作業的 ID，組成路徑名稱
    translate_output_path = f"{account_id}-TranslateText-{translate_job_id}/"
    ```

<br>

5. 可查看路徑。

    ```python
    translate_output_path
    ```

    ![](images/img_21.png)

<br>

6. Amazon Translate 輸出多個檔案，下載 .txt 檔案。

    ```python
    # 建立 S3 資源對象
    s3_resource = boto3.resource("s3")

    # 使用指定名稱建立 bucket
    my_bucket = s3_resource.Bucket(bucket)

    # 過濾 bucket 中以 translate_output_path 作為前綴的物件
    for my_bucket_object in my_bucket.objects.filter(
        Prefix=translate_output_path
    ):
        # 提取每個物件的 key，文件名稱及路徑
        file = my_bucket_object.key

        # 檢查文件是否以 "txt" 結尾，即確認文件格式為文本文件
        if file.endswith("txt"):
            # 去除路徑前綴 translate_output_path，使 file 僅包含文件名稱
            file = file.lstrip(translate_output_path)
            # 去除開頭的 "/" 符號，以獲得乾淨的文件名稱
            file = file.lstrip("/")
            
            # 輸出文件名稱，便於查看下載的文件
            print(file)
            
            # 打開本地文件，準備以二進制寫入方式將文件下載到本地
            with open(file, "wb") as f:
                # 使用 s3_client 將 S3 中的物件下載到本地文件
                s3_client.download_fileobj(bucket, my_bucket_object.key, f)

    ```

<br>

## Amazon Polly example

1. 使用 Polly 建立西班牙文文字檔案的發聲，運行後打開 S3 儲存桶以查看輸出；輸出是一個 `.mp3` 文件，開啟檔案會聽到 Lucia 的聲音說 `Prueba de prueba, este es una prueba`。


    ```python
    # 呼叫 Polly 語音合成服務
    polly_client = boto3.client("polly")

    # 指定要讀取的文件路徑
    itemname = "lab71/polly-sample/es.test.txt"

    # 取得 bucket 中的特定文件對象
    obj = s3_resource.Object(bucket, itemname)

    # 取得文件內容，並將二進制數據解碼為 `UTF-8` 編碼的字串
    body = obj.get()["Body"].read().decode("utf-8")

    # 啟動語音合成作業
    response = polly_client.start_speech_synthesis_task(
        # 指定使用標準語音合成引擎
        Engine="standard",
        # 指定輸出音訊格式
        OutputFormat="mp3",
        # 將輸出結果儲存到的 S3 bucket
        OutputS3BucketName=bucket,
        # 傳入要合成語音的文本內容
        Text=body,
        # 指定語音 ID，這裡使用西班牙語的 Lucia 聲音
        VoiceId="Lucia"
    )
    ```

<br>

2. 從回應中提取任務 ID。

    ```python
    task_id = response["SynthesisTask"]["TaskId"]
    print(task_id)
    ```

    ![](images/img_11.png)

<br>

3. 使用任務 ID 檢查作業是否已完成。

    ```python
    while True:
        # 查詢語音合成作業的狀態
        polly_job = polly_client.get_speech_synthesis_task(TaskId=task_id)
        
        # 檢查作業的狀態是否為 `completed` 或 `failed``
        if polly_job["SynthesisTask"]["TaskStatus"] in ["completed", "failed"]:
            break
        
        # 若作業仍在進行中，暫停 20 秒以避免頻繁查詢狀態
        sleep(20)
        # 每20秒檢查一次，假如仍在進行，就會看到輸出一個點 `.`
        print(".", end="")

    # 循環結束後會輸出最終的作業狀態 `completed` 或 `failed``
    print(polly_job["SynthesisTask"]["TaskStatus"])
    ```

    ![](images/img_12.png)

<br>

4. 下載結果。

    ```python
    # 建立 S3 客戶端
    s3_client = boto3.client("s3")

    # 定義要下載的文件名稱
    polly_output_filename = f"{task_id}.mp3"

    # 以二進制寫入模式 ("wb") 打開輸出文件
    with open(polly_output_filename, "wb") as f:
        # 將 S3 中指定的 的文件下載至本地
        s3_client.download_fileobj(bucket, polly_output_filename, f)
    ```

<br>

##  Challenge exercise

1. 從具有英語音訊通道的影片建立翻譯後的音訊檔案。

<br>

2. 可以使用前三個範例中的程式碼作為解決方案的範本。

<br>

3. 挑戰影片位於 S3 儲存桶的 `lab71/challenge` 資料夾中，影片檔名為 `sample.mp4`，此文件也可在此筆記本實例的「/s3」資料夾中找到。

<br>

___

_END_
