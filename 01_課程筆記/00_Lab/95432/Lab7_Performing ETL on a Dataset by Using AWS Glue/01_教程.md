# ETL

_使用 AWS Glue 對數據集進行 ETL 操作_

### 任務 1: 使用 AWS Glue 爬網程式處理 GHCN-D 資料集
作為數據工程師或分析師，你可能並不總是知道需要分析的數據的結構。AWS Glue 就是為這種情況設計的。你可以將 AWS Glue 指向存儲在 AWS 上的數據，該服務將會發現你的數據。AWS Glue 會將相關的元數據（例如表格定義和結構）存儲在 AWS Glue Data Catalog 中。你可以通過創建爬網程式來實現這一點，該程式會檢查數據源並根據數據推斷結構。

在這個任務中，你將使用存儲在 S3 存儲桶中的公開數據來完成以下工作：
1. 配置並創建 AWS Glue 爬網程式。
2. 運行爬網程式以提取、轉換和加載數據到 AWS Glue 數據庫中。
3. 查看爬網程式創建的表格的元數據。
4. 編輯表格的結構。

首先，你將配置並創建一個爬網程式來發現 GHCN-D 資料集的結構，並從中提取數據。

#### 配置並創建 AWS Glue 爬網程式

1. 在 AWS 管理控制台中，於「服務」旁的搜尋框中搜尋並選擇 AWS Glue，以打開 AWS Glue 控制台。
2. 在左側導航窗格中，於「數據庫」下選擇 Tables（表格）。
3. 選擇 Add tables using crawler（使用爬網程式添加表格）。
4. 在 Name（名稱）欄位中輸入 `Weather`。
5. 展開「標籤（可選）」部分，並保留默認設置。
6. 選擇頁面底部的 Next（下一步）。
7. 選擇 Add a data source（添加數據源），並配置以下內容：
   - Data source：選擇 S3。
   - Location of S3 data：選擇 In a different account（在不同的帳戶中）。
   - S3 path：輸入以下公開資料集的 S3 存儲桶位置：
     ```
     s3://noaa-ghcn-pds/csv/by_year/
     ```
   - Subsequent crawler runs：選擇 Crawl all sub-folders（爬網所有子文件夾）。
   - 選擇 Add an S3 data source（添加 S3 數據源）。
8. 選擇 Next（下一步）。
9. 在「現有 IAM 角色」中，選擇 `gluelab`。
   - 此角色在實驗環境中已經為你提供。如需參考，請查看實驗的 CloudFormation 模板。以下是該角色的 YAML 片段：
   ```yaml
   GlueLab:
     Type: AWS::IAM::Role
     Properties:
       RoleName: "gluelab"
       Path: "/"
       AssumeRolePolicyDocument:
         Version: 2012-10-17
         Statement:
           - Effect: Allow
             Principal:
               Service:
                 - glue.amazonaws.com
             Action:
               - sts:AssumeRole
       ManagedPolicyArns:
         - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
         - arn:aws:iam::aws:policy/AmazonS3FullAccess
   ```

10. 選擇 Next（下一步）。
11. 在「輸出配置」部分，選擇 Add database（添加數據庫）。
12. 新開啟的瀏覽器頁面中，為數據庫輸入名稱 `weatherdata`，然後選擇 Create database（創建數據庫）。
13. 返回打開的 AWS Glue 控制台頁面，並選擇剛創建的 `weatherdata` 數據庫作為目標數據庫。
    - 提示：若未看到數據庫，請點擊右側的 刷新 圖標。
14. 在「爬網程式調度」部分，將 Frequency 保留默認的 On demand（按需）。
15. 選擇 Next（下一步）。
16. 確認你的爬網程式配置與以下設置相似，然後選擇 Create crawler（創建爬網程式）。

#### 運行爬網程式

1. 在爬網程式頁面，選擇剛創建的 `Weather` 爬網程式。
2. 選擇 Run（運行）。
   - 爬網程式狀態將更改為 Running（運行中）。等候狀態變更為 Ready（就緒），這將花費約 3 分鐘。

#### 查看 AWS Glue 創建的元數據

1. 在左側導航窗格中，選擇 Databases（數據庫）。
2. 點擊 `weatherdata` 數據庫的鏈接。
3. 在 Tables 部分，選擇 `by_year` 鏈接。
4. 查看爬網程式捕獲的元數據，並查看表格中檢測到的列。

#### 編輯表格結構

1. 在頁面右上角的 Actions（操作）菜單中，選擇 Edit schema（編輯結構）。
2. 修改列名稱，根據以下表格進行更改：
   - `id` 改為 `station`
   - `date` 改為 `date`
   - `element` 改為 `type`
   - `data_value` 改為 `observation`
   - `m_flag` 改為 `mflag`
   - `q_flag` 改為 `qflag`
   - `s_flag` 改為 `sflag`
   - `obs_time` 改為 `time`

   - 提示：AWS Glue 只支持小寫的列名稱。

3. 選擇 Update schema（更新結構）。

#### 任務 1 總結
在這個任務中，你使用控制台創建了一個 AWS Glue 爬網程式，並指向了存儲在 S3 存儲桶中的數據。爬網程式發現了數據並將相關元數據（包括表格定義和結構）存儲在 AWS Glue Data Catalog 中。這樣可以快速檢查數據源並推斷其結構。團隊可以使用爬網程式來快速檢查數據源，減少手動創建數據庫結構的步驟。

### 任務 2: 使用 Athena 查詢表格
現在，你已經創建了 Data Catalog，接下來可以使用 Athena 進一步查詢數據。

1. 配置 S3 存儲桶以存儲 Athena 查詢結果。
2. 在 Athena 中預覽數據庫表格。
3. 為 1950 年之後的數據創建表格。
4. 對選定數據運行查詢。

首先，打開 Athena 控制台，並確保結果存儲到指定的 S3 存儲桶中，然後運行查詢。

---

我已經完成任務 1 的翻譯，接下來你可以告訴我是否需要進一步翻譯其餘任務的步驟。