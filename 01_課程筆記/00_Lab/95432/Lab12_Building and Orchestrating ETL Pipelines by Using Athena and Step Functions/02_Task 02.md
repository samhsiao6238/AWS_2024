# 自動建立 AWS Glue 資料庫

_使用 Step Functions 工作流來透過 Athena 檢查 AWS Glue 資料庫是否存在，若資料庫不存在，則自動建立該資料庫。_

<br>

## 建立工作流

1. 進入 `Step Functions` 主控台中，選擇 State machines，然後點擊 Create state machine。
2. 當出現範本畫面時，選擇 Cancel，進入 Workflow Studio 介面。
3. 在 Actions 面板中，搜尋 Athena，將 StartQueryExecution 任務拖曳至 Start 和 End 之間。
4. 在右側的 Inspector 面板中：
   - 將 State name 設為 Create Glue DB。
   - 將 API Parameters 替換為以下 JSON 並填入你的 S3 資料桶名稱（<FMI_1> 替換為 `gluelab` 資料桶名稱）：
   ```json
   {
      "QueryString": "CREATE DATABASE if not exists nyctaxidb",
      "WorkGroup": "primary",
      "ResultConfiguration": {
         "OutputLocation": "s3://<FMI_1>/athena/"
      }
   }
   ```
   - 勾選 Wait for task to complete，確保在 Athena 完成資料庫建立或檢查後才進行下一步。
   - Next state 保持為 Go to end。

5. 點擊 Create 完成工作流建立。

#### 步驟 2：設定與測試工作流
1. 在 State machine name 中輸入 WorkflowPOC。
2. 在 Execution role 中選擇 StepLabRole。
3. 完成設定後點擊 Create。

#### 步驟 3：運行工作流
1. 點擊 Start execution，在 Name 欄位中輸入 TaskTwoTest，並選擇 Start execution 開始運行工作流。
2. 工作流運行後，初始狀態會顯示 Running，等待數分鐘直到 Create Glue DB 步驟變為綠色，表示任務成功完成。

#### 步驟 4：驗證結果
1. 在 S3 主控台中，檢查 `gluelab` 資料桶是否生成了新的 `athena` 資料夾。資料夾中應包含一個大小為 0 B 的空白檔案，表示 Athena 查詢成功執行。
2. 在 Glue 主控台中，進入 Databases，檢查是否已成功建立 `nyctaxidb` 資料庫。資料庫目前應該沒有任何表，這是正常的，稍後會添加建立表的步驟。

### 結論
在此任務中，你成功建立了 AWS Glue 資料庫 `nyctaxidb`，並透過 Step Functions 自動化了這一過程。後續任務將擴展此工作流以自動建立表。