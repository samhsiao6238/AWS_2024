# Task 4：根據 AWS Glue 表是否存在向工作流程新增路由邏輯

_在工作流中添加 _判斷 Glue 中是否存在資料庫表的邏輯_，並依此決定工作流的路徑；這個 Task 會使用到前一個步驟中 `Run Table Lookup` 返回的 ID，並基於結果進行不同的流程選擇。

## 更新工作流以查詢結果

1. 在 `Step Functions` 主控台中選擇 `WorkflowPOC` 狀態機，點擊 `Edit` 進行編輯。

![](images/img_52.png)

2. 在 `Actions` 面板中，搜尋 `Athena`，將 `GetQueryResults` 任務拖到 `Run Table Lookup` 和 `End` 兩個任務之間；特別注意，不要使用 `GetQueryExecution` 任務。

![](images/img_53.png)

## 配置 GetQueryResults 任務

1. 選擇 `GetQueryResults` 任務，在 `Inspector` 面板中，將 `State name` 改為 `Get lookup query results`。

![](images/img_54.png)

2. 將 API Parameters 替換為以下代碼，這會傳遞前一個任務的查詢執行 ID 作為輸入。

    ```json
    {
        "QueryExecutionId.$": "$.QueryExecution.QueryExecutionId"
    }
    ```
3. 無需選擇 `Wait for task to complete`，因為這個任務不需要內部輪詢結果；點擊上方的 `{ } Code` 頁籤。

![](images/img_55.png)

4. 確認 JSON 定義如下，並檢查其中 `<替換-S3-Bucket-名稱>` 是否自動填入正確的名稱；點擊右上角 `Save`。

    ```json
    {
        "Comment": "A description of my state machine",
        "StartAt": "Create Glue DB",
        "States": {
            "Create Glue DB": {
                "Type": "Task",
                "Resource": "arn:aws:states:::athena:startQueryExecution.sync",
                "Parameters": {
                    "QueryString": "CREATE DATABASE if not exists nyctaxidb",
                    "WorkGroup": "primary",
                        "ResultConfiguration": {
                            "OutputLocation": "s3://<替換-S3-Bucket-名稱>/athena/"
                        }
                },
                "Next": "Run Table Lookup"
            },
            "Run Table Lookup": {
                "Type": "Task",
                "Resource": "arn:aws:states:::athena:startQueryExecution.sync",
                "Parameters": {
                    "QueryString": "show tables in nyctaxidb",
                    "WorkGroup": "primary",
                    "ResultConfiguration": {
                        "OutputLocation": "s3://<替換-S3-Bucket-名稱>/athena/"
                    }
                },
                "Next": "Get lookup query results"
            },
            "Get lookup query results": {
                "Type": "Task",
                "Resource": "arn:aws:states:::athena:getQueryResults",
                "Parameters": {
                    "QueryExecutionId.$": "$.QueryExecution.QueryExecutionId"
                },
                "End": true
            }
        }
    }
    ```

## 添加選擇狀態

1. 在編輯頁面頂部選擇 Design。
2. 在 Actions 面板中，選擇 Flow 標籤，將 Choice 狀態拖到 Get lookup query results 任務與 End 任務之間。
3. 選中 Choice 狀態，將 State name 更改為 ChoiceStateFirstRun。
4. 在 Choice Rules 部分，為規則 #1，點擊 edit 圖示並進行以下配置：
   - 點擊 Add conditions。
   - 保持預設的 Simple condition。
   - 選擇 Not，將其設為 NOT。
   - 在 Variable 欄位中輸入：
     ```bash
     $.ResultSet.Rows[0].Data[0].VarCharValue
     ```
   - Operator 選擇 is present。
   - 點擊 Save conditions 保存條件。

## 添加兩個 Pass 狀態

1. 在 ChoiceStateFirstRun 狀態的左側（標記為 not... 的箭頭下）拖動一個 Pass 狀態，將 State name 設為 REPLACE ME TRUE STATE。這是一個臨時名稱，稍後會更新。
2. 在 ChoiceStateFirstRun 狀態的右側（標記為 Default 的箭頭下）拖動另一個 Pass 狀態，將 State name 設為 REPLACE ME FALSE STATE。
3. 現在的工作流畫布應該顯示如下圖所示的結構：

   ![Workflow with two pass states](https://aws-tc-largeobjects.s3.us-west-2.amazonaws.com/CUR-TF-200-ACDENG-1/lab-canvas-choice-pass.png)

4. 點擊 Save 保存更改。

## 邏輯解釋

- 當工作流執行並且 Get lookup query results 任務完成後，ChoiceStateFirstRun 狀態將根據最後一次查詢的結果進行評估。如果查詢未找到表（根據 $.ResultSet.Rows[0].Data[0].VarCharValue 邏輯判斷），則工作流將沿 REPLACE ME TRUE STATE 路徑進行，在後續任務中會替換此狀態來創建表。
- 如果查詢找到了表，則工作流將沿 REPLACE ME FALSE STATE 路徑進行，稍後將此狀態替換為檢查新數據（如 2 月的出租車數據）並將其插入到現有的表中。

## 結論
本任務成功在工作流中加入了一個選擇狀態，用來評估查詢結果並根據表的存在性決定下一步的工作流路徑。後續將會替換這些臨時狀態以執行具體操作。