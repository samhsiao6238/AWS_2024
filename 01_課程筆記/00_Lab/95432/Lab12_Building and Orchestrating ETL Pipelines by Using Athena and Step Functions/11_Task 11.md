# Task 11：為資料注入新增工作流程

在此任務中，將 2 月的數據加入工作流程。將使用 `Step Functions` 的映射（Map）狀態來檢查 AWS Glue 中的所有表格，並針對符合條件的表執行 SQL 查詢以插入 2 月份的數據。

---

## 新增 Map 狀態到工作流程

1. 進入 Step Functions 主控台，使用之前的方法打開 WorkflowPOC 狀態機的 Workflow Studio。

2. 在 Actions 面板中，選擇 Flow 頁籤。

3. 將 Map 狀態拖曳到 `REPLACE ME FALSE STATE` 任務與 `End` 任務之間。

4. 刪除 REPLACE ME FALSE STATE 任務。

5. 選取 Map 狀態後，將 State name 更改為 `Check All Tables`。

6. 在 Path to items array 欄位中，輸入 `$.Rows`。

7. 選擇 Input 頁籤，勾選 Filter input with InputPath，並在 InputPath 欄位中輸入 `$.ResultSet`。

   分析：此 `InputPath` 定義了每次迭代中將要分析的數據。

8. 確保 Transform array item with Parameters 未被選擇。

9. 選擇 Configuration 頁籤，並保持 Next state 設為 `Go to end`。

10. 重要： 不要立即應用更改，後續還需要新增其他邏輯。

---

## 新增 Choice 狀態

1. 從 Flow 面板中，將 Choice 狀態拖曳到 `Check All Tables` 任務後的 "Drop state here"。

2. 選取 Choice 狀態後，將 State name 改為 `CheckTable`。

3. 在 Choice Rules 區塊中，選擇 Rule #1 的編輯圖標，並進行以下配置：

   - 點擊 Add conditions。
   - 保持預設的 Simple 條件。
   - 保持 `Not blank`，無需選擇其他選項。
   - 在 Variable 欄位中輸入 `$.Data[0].VarCharValue`。
   - 在 Operator 中選擇 `matches string`。
   - 在 Value 中輸入 `*data_parquet`。

   分析：此邏輯會遍歷所有 AWS Glue 表名稱，檢查名稱是否匹配 `data_parquet` 結尾的表格。這樣即可定位唯一符合條件的表格，即 `yellowtaxi_data_parquet`。

4. 點擊 Save conditions。

---

## 新增 Pass 狀態並配置預設邏輯

1. 從 Flow 面板中，將 Pass 狀態拖曳到 `CheckTable` 任務後方右側箭頭的 Default 標籤下。

2. 選取 Pass 狀態後，將 State name 設為 `Ignore File`。

3. 在畫布上，選擇 CheckTable 狀態下方箭頭的 Default 標籤。

4. 在右側的 Choice Rules 區塊中，打開 Default rule 詳細信息。

5. 確認 Default state 設為 `Ignore File`。

   分析：此預設規則會處理所有不符合條件的 AWS Glue 表，確保只有 `yellowtaxi_data_parquet` 表會進行修改。

---

## 新增 StartQueryExecution 任務以更新 Parquet 表

1. 在 Flow 面板中，切換到 Actions 頁籤，搜尋 athena。

2. 將 StartQueryExecution 任務拖曳到 `CheckTable` 任務後方左側。

3. 選取該任務後，將 State name 改為 `Insert New Parquet Data`。

4. 在 API Parameters 中，將預設的 JSON 代碼替換為以下內容，並將 `<FMI_1>` 替換為實際的 S3 bucket 名稱：

    ```json
    {
       "QueryString": "INSERT INTO nyctaxidb.yellowtaxi_data_parquet select vendorid,tpep_pickup_datetime,tpep_dropoff_datetime,passenger_count,trip_distance,ratecodeid,store_and_fwd_flag,pulocationid,dolocationid,fare_amount,extra,mta_tax,tip_amount,tolls_amount,improvement_surcharge,total_amount,congestion_surcharge,payment_type,substr(\"tpep_pickup_datetime\",1,4) pickup_year, substr(\"tpep_pickup_datetime\",6,2) AS pickup_month FROM nyctaxidb.yellowtaxi_data_csv where substr(\"tpep_pickup_datetime\",1,4) = '2020' and substr(\"tpep_pickup_datetime\",6,2) = '02'",
       "WorkGroup": "primary",
       "ResultConfiguration": {
         "OutputLocation": "s3://<FMI_1>/athena/"
       }
    }
    ```

5. 選擇 Wait for task to complete 以確保任務完成後才繼續執行工作流程。

6. 確保 Next state 設為 `Go to end`。

7. 確認新增的邏輯與下圖相符：

    ![Workflow with Insert New Parquet Data and Ignore File states](images/task11_workflow.png)

8. 點擊 Save 保存工作流程。

---

## 總結

在此任務中，成功將邏輯加入工作流程，使其能自動處理新增月份的數據，並只修改目標 Parquet 表格 `yellowtaxi_data_parquet`。