# Task 9：在 Athena 中創建視圖

此任務的目標是在 Athena 查詢編輯器中創建一個數據視圖，該視圖將結合存儲在 Parquet 格式中的兩個表的數據。

## 使用 Athena 查詢編輯器創建新視圖

1. 在 Athena 主控台的 `Data` 面板中，找到 `Tables and views` 區塊。

2. 點擊 `Create`，然後選擇 `CREATE VIEW`。

3. 在查詢標籤中，系統將自動填充以下 SQL 指令來幫助開始創建視圖：

    ```sql
    -- View Example
    CREATE OR REPLACE VIEW view_name AS
    SELECT column1, column2
    FROM table_name
    WHERE condition;
    ```

4. 將預設的指令替換為以下 SQL 語句：

    ```sql
    create or replace view nyctaxidb.yellowtaxi_data_vw as 
    select a.*, lkup.* 
    from (
        select 
            datatab.pulocationid pickup_location,
            pickup_month,
            pickup_year,
            sum(cast(datatab.total_amount AS decimal(10, 2))) AS sum_fare,
            sum(cast(datatab.trip_distance AS decimal(10, 2))) AS sum_trip_distance,
            count(*) AS countrec
        FROM nyctaxidb.yellowtaxi_data_parquet datatab
        WHERE datatab.pulocationid IS NOT NULL
        GROUP BY datatab.pulocationid, pickup_month, pickup_year
    ) a, 
    nyctaxidb.nyctaxi_lookup_parquet lkup
    WHERE lkup.locationid = a.pickup_location;
    ```

    > 注意：此 SQL 指令將兩個 Parquet 表 `yellowtaxi_data_parquet` 和 `nyctaxi_lookup_parquet` 中的數據結合，並生成一個名為 `yellowtaxi_data_vw` 的視圖。視圖將根據 `pulocationid`（取車地點）進行匯總，並計算該地點每月、每年的乘車總費用 (`sum_fare`)、總里程 (`sum_trip_distance`) 以及乘車次數 (`countrec`)。

5. 點擊 `Run` 運行查詢。

    - 查詢執行成功後，`Data` 面板中的 `Views` 區塊會列出新創建的 `yellowtaxi_data_vw` 視圖。

6. 展開新視圖的詳細信息，下圖顯示了視圖的展開視圖：

    ![](images/task9_view_expanded.png)

    > 在展開視圖的時候，可以看到 `sum_fare` 和 `sum_trip_distance` 等匯總欄位。

7. 點擊視圖名稱右側的三個點圖標，選擇 `Preview View`，預覽視圖的結果。

    - 預覽的結果如下圖所示：

    ![](images/task9_view_preview.png)

    > 結果展示了視圖中生成的匯總信息，例如乘車總費用、總里程以及乘車次數。

---

## 總結

至此，已成功在 Athena 中創建了一個視圖，該視圖通過查詢兩個 Parquet 表的數據，將其結合並生成匯總結果。此視圖為團隊提供了更清晰的數據洞察，幫助更高效地分析出租車數據。