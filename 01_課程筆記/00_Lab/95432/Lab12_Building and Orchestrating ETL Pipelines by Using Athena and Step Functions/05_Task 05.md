# Task 5：為 Yellow Taxi 數據建立 AWS Glue 表

_任務目的是在工作流程中加入邏輯，以在 `Glue` 資料庫中建立表，當資料庫中不存在表時進行該操作。_

## 新增 Athena StartQueryExecution 任務以建立表

1. 在 `Actions` 標籤中搜尋 Athena。
2. 將 StartQueryExecution 任務拖曳到 ChoiceStateFirstRun 狀態與 REPLACE ME TRUE STATE 之間。
3. 選中 StartQueryExecution 任務後，將 State name 修改為 Run Create data Table Query。
4. 保持 Integration type 為 Optimized。
5. 將 API Parameters 的預設 JSON 替換為以下代碼，並將 `<FMI_1>` 和 `<FMI_2>` 替換為實際的 S3 資料桶名稱：
   ```json
   {
       "QueryString": "CREATE EXTERNAL TABLE nyctaxidb.yellowtaxi_data_csv(  vendorid bigint,   tpep_pickup_datetime string,   tpep_dropoff_datetime string,   passenger_count bigint,   trip_distance double,   ratecodeid bigint,   store_and_fwd_flag string,   pulocationid bigint,   dolocationid bigint,   payment_type bigint,   fare_amount double,   extra double,   mta_tax double,   tip_amount double,   tolls_amount double,   improvement_surcharge double,   total_amount double,   congestion_surcharge double) ROW FORMAT DELIMITED   FIELDS TERMINATED BY ',' STORED AS INPUTFORMAT   'org.apache.hadoop.mapred.TextInputFormat' OUTPUTFORMAT   'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat' LOCATION  's3://<FMI_1>/nyctaxidata/data/' TBLPROPERTIES (  'skip.header.line.count'='1')",
       "WorkGroup": "primary",
       "ResultConfiguration": {
         "OutputLocation": "s3://<FMI_2>/athena/"
       }
   }
   ```
6. 這個查詢會使用 Athena 的 CREATE EXTERNAL TABLE 語句來建立一個指向 S3 存儲數據的 Glue 表，定義了數據的列和數據類型。
7. 勾選 Wait for task to complete，確保表完全建立後才繼續執行工作流程。
8. 在 Next state 中選擇 Go to end。
9. 刪除 REPLACE ME TRUE STATE，確保該狀態不再出現在畫布上。
10. 點擊 Save 保存工作流。

#### 步驟 2：測試工作流程

1. 選擇 Execute，並將執行名稱設為 TaskFiveTest，然後選擇 Start execution 開始執行工作流。
2. 等待工作流中每個步驟從白色變為藍色，再變為綠色，代表任務成功執行。
3. 此次運行不會建立新資料庫，但因為資料庫中找不到表，工作流將執行 Run Create data Table Query 任務來建立表。

#### 步驟 3：驗證表的建立

1. 在 Amazon S3 主控台中，導航到 gluelab 資料桶中的 athena 資料夾。
2. 注意到該資料夾中有新的元數據文件和一些空的文本文件，這些空文件是 Step Functions 任務的基本輸出，可忽略。
3. 在 AWS Glue 主控台的導航面板中，選擇 Tables，可以看到一個名為 yellowtaxi_data_csv 的表已存在。這是工作流運行時由 Athena 建立的 Glue 表。
4. 點擊表的鏈接查看詳細的結構，確認表格的架構定義是否正確。

#### 步驟 4：再次運行工作流測試另一條路徑

1. 在 Step Functions 主控台中，選擇 WorkflowPOC 狀態機並點擊 Start execution。
2. 將執行名稱設為 NewTest 並再次選擇 Start execution。
3. 等待工作流成功執行，這次會檢查是否已存在該表，應選擇另一條邏輯路徑並調用 REPLACE ME FALSE STATE 狀態。
4. 此次運行不會重新建立資料庫或覆寫已建立的表，但會在 S3 中生成一些包含更新的 AWS Glue 元數據的輸出文件。

### 結論
本任務成功建立了指向 Yellow Taxi 數據的 AWS Glue 表，並將其整合到工作流中，當資料庫中不存在表時自動建立。此外，工作流的另一條邏輯路徑確保在表已存在時，不會重新建立表。