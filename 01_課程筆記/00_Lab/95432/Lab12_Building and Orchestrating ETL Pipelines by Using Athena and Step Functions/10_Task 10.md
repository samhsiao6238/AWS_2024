# Task 10：將視圖創建步驟加入 Step Functions 工作流程

在此任務中，將視圖創建任務加入到現有的工作流程中，確保當資料不存在時，工作流程能自動創建視圖。這樣，當新增數據時不需要每次手動重建視圖。

---

## 刪除先前手動創建的視圖

1. 在 Amazon S3 主控台中，導航到 nyctaxidata 資料夾，位於 gluelab bucket 中。

2. 刪除名稱中包含 optimized 的所有前綴資料夾。

3. 在 AWS Glue 主控台中，刪除所有五個表。

---

## 將創建視圖的步驟加入 Step Functions 工作流程

1. 進入 Step Functions 主控台，使用之前的步驟進入 WorkflowPOC 狀態機的 Workflow Studio。

2. 在 Actions 面板中，搜尋 Athena。

3. 將一個 StartQueryExecution 任務拖曳到 `Run Create Parquet data Table Query` 任務與 `End` 任務之間。

4. 選中該任務後，將 State name 改為 `Run Create View`。

5. 在 API Parameters 中，將預設的 JSON 代碼替換為以下內容，並用實際的 S3 bucket 名稱替換 `<FMI_1>`：

    ```json
    {
        "QueryString": "create or replace view nyctaxidb.yellowtaxi_data_vw as select a.*, lkup.* from (select datatab.pulocationid pickup_location, pickup_month, pickup_year, sum(cast(datatab.total_amount AS decimal(10, 2))) AS sum_fare, sum(cast(datatab.trip_distance AS decimal(10, 2))) AS sum_trip_distance, count(*) AS countrec FROM nyctaxidb.yellowtaxi_data_parquet datatab WHERE datatab.pulocationid is NOT null GROUP BY datatab.pulocationid, pickup_month, pickup_year) a, nyctaxidb.nyctaxi_lookup_parquet lkup WHERE lkup.locationid = a.pickup_location",
        "WorkGroup": "primary",
        "ResultConfiguration": {
            "OutputLocation": "s3://<FMI_1>/athena/"
        }
    }
    ```

6. 選擇 `Wait for task to complete` - 這會確保創建視圖的操作完成後才繼續執行下一步。

7. 點擊 Save 保存工作流程。

---

## 測試工作流程

1. 使用之前的步驟運行 WorkflowPOC 狀態機。

2. 將測試命名為 `TaskTenTest`，運行工作流程。

3. 下圖顯示了完成後的工作流程，其中包含了 Run Create View 任務：

    ![](images/task10_completed_workflow.png)

---

## 總結

在這一步中，成功將創建視圖的任務加入到工作流程中，構建了一個完整的 ETL 管道 POC。這個 POC 的設計簡單易用，方便新項目快速上手使用。只需替換新的 bucket 位置，並根據數據格式更新查詢及分區邏輯，即可輕鬆運行工作流程。

在這個實施中，唯一未處理的情況是如何處理新加入的時間序列數據（例如新增 2 月份數據）。這將是接下來要解決的問題。