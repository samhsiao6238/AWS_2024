# AWS Athena

_此 Lab 是使用 AWS Athena 和 AWS Glue 來查詢儲存在 Amazon S3 中的數據，包含建立 Glue 資料庫與表格、查詢並優化 Athena 的查詢，以及使用 Athena 視圖來簡化數據分析。_

## 目標

1. 使用 Athena 查詢編輯器建立 AWS Glue 資料庫與表格。

2. 使用 Athena 查詢 S3 中的數據集，並進行優化。

3. 建立 Athena 視圖來簡化數據查詢。

## 建立並查詢 AWS Glue 資料庫與表格

1. 進入主控台搜尋並進入 `Athena`。

![](images/img_01.png)

2. 啟動查詢編輯器。

![](images/img_02.png)

3. 切換到 `Settings` 頁籤，在 `Query result and encryption settings` 中選擇 `Manage`。

![](images/img_03.png)

4. 在 `Location of query result` 選擇 `Browse S3`。

![](images/img_04.png)

5. 選取預設的 `S3 Bucket`，點擊右下角 `Choose`。

![](images/img_05.png)

6. 這個頁面使用預設值即可，點擊 `Save`。

![](images/img_06.png)

## 建立 `Glue` 資料庫

1. 切換到 `Editor`。

![](images/img_07.png)

2. 在 `Athena` 查詢編輯器中，輸入以下 SQL 指令建立資料庫，選擇 `Run` 以執行指令。

    ```sql
    CREATE DATABASE taxidata;
    ```

    ![](images/img_08.png)

## 查看

1. 搜尋並進入 `Glue`。

![](images/img_09.png)

2. 點擊左側 `Databases` 後，便可以查看資料庫。

![](images/img_10.png)

## 回到 Athena

1. 建立 Glue 表格，在 `Tables and views` 部分，選擇 `Create > S3 bucket data`。

![](images/img_11.png)

2. 設定表格名稱為 `yellow`，描述為 `Table for taxi data`，選擇剛剛建立的 `taxidata` 資料庫。

![](images/img_12.png)

3. 輸入 S3 資料位置 `Location of input data set`。

    ```
    s3://aws-tc-largeobjects/CUR-TF-200-ACDSCI-1/Lab2/yellow/
    ```

    ![](images/img_13.png)

4. 選擇數據格式為 CSV。

    ![](images/img_14.png)

5. 並使用 `Bulk add columns` 來快速添加欄位名稱與類型。

![](images/img_15.png)

6. 在彈窗中輸入以下內容，這是快速添加 `metadata` 的方法。

![](images/img_16.png)

7. 可在 `Preview table query` 進行預覽，然後點擊右下角 `Preview Table`。

![](images/img_17.png)

8.  以上成功建立了 Glue 資料庫與表格，並導入了儲存在 S3 的數據，完成了表格的欄位定義與數據預覽。

## 優化 Athena 查詢

1. 建立表格 `jan`，輸入以下 SQL 指令來建立 1 月數據的表格，然後，針對 `jan` 表格運行相似查詢，並比較執行時間與掃描數據量。

    ```sql
    CREATE EXTERNAL TABLE IF NOT EXISTS jan (
    `vendor` string,
    `pickup` timestamp,
    `dropoff` timestamp,
    ...
    )
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'
    LOCATION 's3://aws-tc-largeobjects/CUR-TF-200-ACDSCI-1/Lab2/January2017/'
    TBLPROPERTIES ('has_encrypted_data'='false');
    ```

1. 執行並比較查詢，首先，針對 `yellow` 表格運行查詢，這些操作將數據按月份分割，並通過 bucketizing 優化查詢性能。

    ```sql
    SELECT count (count) AS "Number of trips", sum (total) AS "Total fares", pickup AS "Trip date"
    FROM yellow WHERE pickup BETWEEN TIMESTAMP '2017-01-01 00:00:00' AND TIMESTAMP '2017-02-01 00:00:01'
    GROUP BY pickup;
    ```

## 使用分區優化查詢

1. 建立分區表格 `creditcard`，執行以下查詢，將數據按付款類型進行分區。

    ```sql
    CREATE TABLE taxidata.creditcard
    WITH (format = 'PARQUET') AS
    SELECT * FROM yellow WHERE paytype = '1';
    ```

1. 比較查詢性能，首先查詢未分區表格 `yellow`，然後查詢分區表格 `creditcard`，比較執行時間和數據掃描量，這些操作使用列式存儲格式（如 Parquet）來優化低基數字段的查詢性能。

    ```sql
    SELECT sum(total), paytype FROM yellow WHERE paytype = '1' GROUP BY paytype;
    ```


## 使用 Athena 視圖

1. 建立信用卡付款的總計視圖。

```sql
CREATE VIEW cctrips AS
SELECT "sum"(fare) "CreditCardFares" FROM yellow WHERE paytype='1';
```

1. 建立並聯合兩個視圖，聯合信用卡與現金付款視圖，並比較總付款，使用 Athena 視圖來簡化查詢，並通過建立聯合視圖來比較多個視圖的數據。

```sql
CREATE VIEW comparepay AS
WITH cc AS (SELECT sum(fare) AS cctotal, vendor FROM yellow WHERE paytype = '1' GROUP BY vendor),
cs AS (SELECT sum(fare) AS cashtotal, vendor FROM yellow WHERE paytype = '2' GROUP BY vendor)
SELECT cc.cctotal, cs.cashtotal FROM cc JOIN cs ON cc.vendor = cs.vendor;
```

## 使用 CloudFormation 建立 Athena 命名查詢

1. 建立 CloudFormation 模板，在 Cloud9 中建立新文件 `athenaquery.cf.yml` 並輸入以下內容。

```yaml
AWSTemplateFormatVersion: 2010-09-09
Resources:
    AthenaNamedQuery:
    Type: AWS::Athena::NamedQuery
    Properties:
        Database: "taxidata"
        Description: "A query that selects all fares over $100.00 (US)"
        Name: "FaresOver100DollarsUS"
        QueryString: > 
        SELECT distance, paytype, fare, tip, tolls, surcharge, total
        FROM yellow WHERE total >= 100.0 ORDER BY total DESC
```

1. 部署模板，執行以下指令來部署 CloudFormation 堆疊，使用 CloudFormation 來建立可重用的 Athena 查詢模板，並將其部署到 AWS。

```bash
aws cloudformation create-stack --stack-name athenaquery --template-body file://athenaquery.cf.yml
```

## 檢視 IAM 策略

1. 檢視 `Policy-For-Data-Scientists`，前往 IAM 控制台，選擇用戶 `mary`，並檢視擁有的策略 `Policy-For-Data-Scientists`；確認了 `DataScienceGroup` 的 IAM 策略，並檢查了該策略對 S3、Glue 和 Athena 的訪問權限。

## 確認 Mary 的查詢訪問權限

1. 使用 Mary 的 IAM 用戶進行測試，使用 AWS CLI 測試 Mary 是否能夠訪問命名查詢；確認了 Mary 可以使用適當的權限訪問並運行 Athena 命名查詢。
```bash
AWS_ACCESS_KEY_ID=$AK AWS_SECRET_ACCESS_KEY=$SAK aws athena get-named-query --named-query-id $NQ
```

## 完成